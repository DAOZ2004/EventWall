{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>{{ comunidad.nombre }} - EventWall</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="icon" href="{% static 'img/EventWall.jpg' %}" type="image/x-icon">

    <style>
        /* Estilos locales para esta plantilla */
        :root{
            --accent: #6a00ff;
            --muted: #6b7280;
            --danger: #ef4444;
            --card-bg: #fff;
            --shadow: 0 10px 30px rgba(15,23,42,0.08);
            --radius: 12px;
        }
        body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background: linear-gradient(180deg,#2b0f35 0,#a8c7f2 100%); color:#0f172a; }
        .main-container { max-width:1100px; margin:30px auto; padding: 0 16px; }
        .card-panel { background: rgba(255,255,255,0.95); border-radius:20px; padding:22px; box-shadow: 0 8px 40px rgba(2,6,23,0.15); }
        .page-title { margin:0 0 6px 0; color:#4b1650; font-size:1.6rem; }
        .page-subtitle { margin:0 0 12px 0; color:var(--muted); }

        .detail-actions { display:flex; gap:10px; align-items:center; }
        .small-btn { padding:8px 10px; font-size:0.9rem; border-radius:10px; text-decoration:none; border:none; cursor:pointer; }
        .btn-ghost { background:#f3f4f6; color:#374151; border-radius:10px; padding:8px 10px; text-decoration:none; border:1px solid rgba(0,0,0,0.06); }
        .btn { background:var(--accent); color:white; padding:9px 12px; border-radius:12px; text-decoration:none; }
        .btn-danger { background:var(--danger); color:white; padding:8px 12px; border-radius:12px; border:none; cursor:pointer; }
        .members-badge { font-size:0.85rem; color:var(--muted); margin-left:6px; }

        .events-list { list-style:none; padding:0; margin: 16px 0 0 0; display:flex; flex-direction:column; gap:12px; }
        .event-card { background:var(--card-bg); border-radius:12px; padding:14px; box-shadow: var(--shadow); display:flex; gap:12px; align-items:flex-start; justify-content:space-between; }
        .event-title { font-weight:700; color:#3b0758; display:flex; gap:8px; align-items:center; }
        .event-meta { color:var(--muted); margin-top:6px; font-size:0.9rem; }
        .badge { background:#f3f0ff; color:#4b1650; padding:6px 8px; border-radius:999px; font-size:0.75rem; }

        .event-actions { display:flex; flex-direction:column; gap:8px; align-items:flex-end; }

        @media (max-width:700px){
            .detail-actions { flex-direction:column; align-items:stretch; }
            .event-actions { align-items:flex-start; }
        }
    </style>
</head>
<body>
<header style="background:rgba(255,255,255,0.9); padding:10px 0; box-shadow:0 2px 6px rgba(2,6,23,0.04);">
    <div style="max-width:1100px; margin:0 auto; padding:0 16px; display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; gap:10px; align-items:center;">
            <img src="{% static 'img/EventWall.jpg' %}" alt="logo" style="width:36px;height:36px;border-radius:8px;">
            <div>
                <div style="font-weight:700;">EventWall</div>
                <div style="font-size:0.8rem; color:var(--muted);">Gestión de eventos</div>
            </div>
        </div>
        <nav style="display:flex; gap:12px;">
            <a href="{% url 'home' %}">Inicio</a>
            <a href="{% url 'eventos_list' %}">Eventos</a>
            <a href="{% url 'Comunidades' %}">Comunidades</a>
            <a href="{% url 'CrearComunidad' %}">Crear</a>
            <a href="{% url 'logout' %}">Cerrar sesión</a>
        </nav>
    </div>
</header>

<main>
    <div class="main-container">
        <section class="card-panel">

            <div style="display:flex; gap:18px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;">
                <div style="flex:1; min-width:220px;">
                    <h2 class="page-title">{{ comunidad.nombre }}</h2>
                    <p class="page-subtitle">{{ comunidad.descripcion|default:"Sin descripción" }}</p>
                    <p style="margin:6px 0 0 0; color:var(--muted); font-size:0.9rem;">
                        Creada el {{ comunidad.creada_en|date:"d/m/Y H:i" }}
                        {% if comunidad.miembros.count %}
                            · <span class="members-badge">{{ comunidad.miembros.count }} miembros</span>
                        {% endif %}
                    </p>
                </div>

                <div class="detail-actions" style="margin-left:12px;">
                    <a class="small-btn btn-ghost" href="{% url 'comunidad_miembros' comunidad.id %}">Ver miembros</a>

                    {# is owner? (evaluado en plantilla) #}
                    {% if comunidad.propietario == request.user %}
                        {% comment %} propietario: mostrar editar/eliminar y que siempre sea miembro {% endcomment %}
                        <a href="{% url 'comunidad_detalle' comunidad.id %}" class="small-btn" style="background:#fff2f2; color:#b91c1c; border-radius:10px; text-decoration:none; padding:8px 10px;">Propietario</a>

                        <a href="{% url 'evento_crear_en_comunidad' comunidad.id %}" class="btn">+ Nuevo evento</a>

                        <form method="post" action="{% url 'comunidad_eliminar' comunidad.id %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn-danger" onclick="return confirm('¿Eliminar la comunidad? Esta acción no se puede deshacer.');">Eliminar comunidad</button>
                        </form>

                    {% else %}
                        {# no es propietario: comprobar si ya es miembro usando la variable que la vista debe pasar: 'es_miembro' #}
                        {% if es_miembro %}
                            <form method="post" action="{% url 'salir_comunidad' comunidad.id %}" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="small-btn" style="background:#fff2f2; border:1px solid #f3caca; color:#b91c1c;">Salir de la comunidad</button>
                            </form>

                            <a href="{% url 'evento_crear_en_comunidad' comunidad.id %}" class="btn">+ Nuevo evento</a>
                        {% else %}
                            <form method="post" action="{% url 'unirse_comunidad' comunidad.id %}" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="small-btn" style="background:#e6f4ff; border:1px solid #9bd0ff; color:#0369a1;">Unirse a la comunidad</button>
                            </form>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            <div style="margin-top:18px; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">Eventos en {{ comunidad.nombre }}</h3>
                {# si es miembro o propietario, ya mostramos el botón arriba; aquí dejamos un mensaje condicional #}
                {% if not es_miembro and comunidad.propietario != request.user %}
                    <span style="color:var(--muted); font-size:0.9rem;">Únete para poder publicar eventos</span>
                {% endif %}
            </div>

            <ul class="events-list">
                {% for evento in eventos %}
                    <li class="event-card">
                        <div style="flex:1;">
                            <div class="event-title">
                                <span>{{ evento.titulo }}</span>
                                <span class="badge">{{ evento.get_tipo_display }}</span>
                            </div>

                            <div class="event-meta">
                                {{ evento.fecha|date:"d/m/Y" }}
                                · {% if evento.hora %}{{ evento.hora|time:"g:i A" }}{% else %}Hora no definida{% endif %}
                                {% if evento.lugar %} · {{ evento.lugar }}{% endif %}
                            </div>

                            {% if evento.descripcion %}
                                <p style="margin-top:8px; color:#374151;">{{ evento.descripcion }}</p>
                            {% endif %}
                        </div>

                        <div class="event-actions">
                            <a href="{% url 'evento_detalle' evento.id %}" class="btn-ghost small-btn" style="text-align:center;">Ver</a>

                            {# mostrar editar/eliminar solo si el request.user es creador o propietario de la comunidad #}
                            {% if evento.creado_por == request.user or comunidad.propietario == request.user %}
                                <div style="display:flex; gap:8px;">
                                    <a href="{% url 'evento_editar' evento.id %}" class="small-btn btn-ghost">Editar</a>

                                    <form method="post" action="{% url 'evento_eliminar' evento.id %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn-danger" onclick="return confirm('¿Eliminar este evento?');">Eliminar</button>
                                    </form>
                                </div>
                            {% endif %}
                        </div>
                    </li>
                {% empty %}
                    <li style="padding:18px; color:var(--muted);">
                        No hay eventos en esta comunidad todavía.
                        {% if es_miembro or comunidad.propietario == request.user %}
                            &nbsp;Crea el primero con el botón de arriba.
                        {% else %}
                            &nbsp;Únete para ver y crear eventos.
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>

        </section>
    </div>
</main>

</body>
</html>